<!DOCTYPE html>
<html lang="de">
<head>
<link rel="icon" href="https://raw.githubusercontent.com/hoedii/3D-Druck-Kostenrechner/main/Logo.png" type="image/png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>3D Druck Kostenrechner</title>
<style>
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background-color: #f4f4f9;
margin: 0;
padding: 0;
}
header {
background-color: #64b5f6;
color: white;
padding: 20px;
display: flex;
align-items: center;
justify-content: center;
gap: 15px;
position: relative;
}
header img {
height: 50px;
}
.container {
max-width: 800px;
margin: 20px auto;
padding: 20px;
background-color: white;
border-radius: 8px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
h2 {
font-size: 24px;
margin-bottom: 15px;
}
input[type="file"] {
padding: 10px;
margin: 10px 0;
border: 1px solid #ccc;
border-radius: 4px;
width: 100%;
}
button {
background-color: #64b5f6;
color: white;
padding: 15px 20px;
border: none;
border-radius: 4px;
font-size: 16px;
cursor: pointer;
width: 100%;
margin-top: 10px;
}
button:hover {
background-color: #90caf9;
}
.output {
margin-top: 20px;
}
.output p {
font-size: 18px;
margin: 10px 0;
}
.error {
color: red;
}
.result-header {
font-size: 20px;
font-weight: bold;
margin-top: 20px;
}
.clear-button {
background-color: #ccc;
color: #333;
padding: 8px 12px;
border-radius: 4px;
font-size: 14px;
width: auto;
margin: 20px 0 0 0;
display: inline-block;
cursor: pointer;
}
.clear-button:hover {
background-color: #bbb;
}
.accordion {
margin-top: 10px;
background-color: #f1f1f1;
color: #444;
cursor: pointer;
padding: 15px;
width: 96%;
border: none;
text-align: left;
outline: none;
font-size: 18px;
transition: 0.4s;
border-radius: 4px;
display: flex;
justify-content: space-between;
align-items: center;
}
.active, .accordion:hover {
background-color: #ccc;
}
.panel {
padding: 0 18px;
display: none;
overflow: hidden;
background-color: #f7f7f7;
border-left: 4px solid #64b5f6;
}
.delete-button {
background-color: #ff4d4d;
color: white;
padding: 5px 10px;
border-radius: 4px;
font-size: 14px;
cursor: pointer;
margin-top: 10px;
}
.delete-button:hover {
background-color: #e60000;
}
.total-cost-container {
    margin-top: 20px;
    padding: 20px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    text-align: left;
    margin-bottom: 10px;
}
.total-cost-container p {
font-size: 18px;
margin: 5px 0;
}
#clearAllButton {
background-color: transparent;
color: #aaa;
padding: 0;
border: none;
font-size: 16px;
cursor: pointer;
display: block;
text-align: left;
width: 100%;
margin-top: 20px;
text-decoration: underline;
}
.accordion::after {
content: " ▼";
font-size: 18px;
}
.active::after {
content: " ▲";
}
footer {
text-align: center;
font-size: 12px;
color: #777;
margin-top: 50px;
padding: 10px 0;
}

/* Settings Modal Styles */
.settings-button {
    background: transparent;
    border: 2px solid white;
    color: white;
    padding: 0 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    width: auto;
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    white-space: nowrap;
}

.download-button {
    background: transparent;
    border: 2px solid white;
    color: white;
    padding: 0 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    width: auto;
    position: absolute;
    right: 245px;
    top: 50%;
    transform: translateY(-50%);
    height: 35px;
    display: none;
    align-items: center;
    justify-content: center;
    gap: 6px;
    white-space: nowrap;
}

.pdf-button {
    background: transparent;
    border: 2px solid white;
    color: white;
    padding: 0 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    width: auto;
    position: absolute;
    right: 160px;
    top: 50%;
    transform: translateY(-50%);
    height: 35px;
    display: none;  /* Standardmäßig ausgeblendet */
    align-items: center;
    justify-content: center;
    gap: 6px;
    white-space: nowrap;
}

.pdf-button svg, .download-button svg, .settings-button svg {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.button-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    height: 100%;
}

.button-text {
    display: inline-block;
    line-height: 1;
}

.download-button:hover, .pdf-button:hover, .settings-button:hover {
    background: rgba(144, 202, 249, 0.2);
}

.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 3% auto;
    padding: 20px;
    border-radius: 8px;
    width: 95%;
    max-width: 1400px;
    max-height: 90vh;
    overflow-y: auto;
}

.close {
color: #aaa;
float: right;
font-size: 28px;
font-weight: bold;
cursor: pointer;
}

.close:hover {
color: #000;
}

.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

@media (max-width: 1200px) {
    .settings-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
}

@media (max-width: 768px) {
    .settings-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 90%;
        margin: 5% auto;
    }
}

.settings-group {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    box-sizing: border-box;
}

.settings-group h3 {
margin-top: 0;
margin-bottom: 10px;
font-size: 16px;
}

.setting-item {
    margin-bottom: 15px;
    position: relative;
    width: 90%;
}

.setting-item input[type="number"] {
    -moz-appearance: textfield;
}

.setting-item input[type="number"]::-webkit-outer-spin-button,
.setting-item input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.reset-button {
    position: absolute;
    right: 8px;
    top: calc(50% + 3px);
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #ff4d4d;
    cursor: pointer;
    padding: 0;
    font-size: 14px;
    display: none;
    z-index: 1;
    width: 14px;
    height: 14px;
    line-height: 14px;
    text-align: center;
}

.reset-button:hover {
    color: #000;
    background: none;
}

.setting-item.changed .reset-button {
    display: block;
}

.setting-item.changed input {
    padding-right: 25px;
}

.setting-item input {
    transition: padding-right 0.2s;
    padding-right: 8px;
}

.setting-item label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
    text-align: left;
    width: 100%;
}

.setting-item input {
    width: 100%;
    padding: 8px;
    padding-right: 30px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
}

.settings-actions {
margin-top: 20px;
display: flex;
gap: 10px;
justify-content: flex-end;
}

.settings-actions button {
width: auto;
padding: 10px 20px;
}

.import-export-buttons {
display: flex;
gap: 10px;
margin-bottom: 20px;
}

.import-export-buttons button {
width: auto;
padding: 10px 20px;
background-color: #666;
}

.import-export-buttons button:hover {
background-color: #555;
}

.file-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 10px;
}

.file-input-group {
    display: flex;
    align-items: center;
    width: 100%;
}

.file-input-group label {
    flex: 1;
}

.file-input-group input[type="file"] {
    flex: 1;
}

#fileStatus {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 50%;
    margin-left: 10px;
}

.folder-button {
    display: none !important;
}

.export-group {
    display: none !important;
}

#exportBtn {
    display: none !important;
}

.button-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.button-group button {
    flex: 1;
}

.button-group button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

.input-section {
    width: 100%;
    margin-bottom: 10px;
}

.custom-file-input {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 10px;
    background-color: #fff;
    cursor: pointer;
    width: 100%;
    box-sizing: border-box;
    text-align: left;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.custom-file-input:hover {
    background-color: #f8f8f8;
}

.button-text {
    font-weight: normal;
}

.file-status {
    margin-left: 20px;
    font-size: 14px;
}

.folder-status {
    margin-left: 20px;
    font-size: 14px;
}

.subtle-button {
    background: none;
    border: none;
    color: #888;
    padding: 5px 0;
    font-size: 13px;
    cursor: pointer;
    width: 100%;
    text-align: left;
    margin-top: 5px;
}

.subtle-button:hover {
    color: #666;
    text-decoration: underline;
}

@media (max-width: 768px) {
    .download-button, .pdf-button, .settings-button {
        position: static;
        transform: none;
        margin: 5px;
        padding: 0 12px;
    }
    
    header {
        flex-wrap: wrap;
        justify-content: center;
        padding: 10px;
    }
    
    .button-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }
}

/* Additional styles for recipient modal */
.settings-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
}

.settings-actions button {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 14px;
}

.modal textarea {
    font-family: inherit;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: vertical;
}

.modal input:required {
    border-left: 3px solid #64b5f6;
}

.modal-content {
    padding: 25px;
}

.settings-grid {
    margin-top: 20px;
}

.settings-group {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
}

.settings-group h3 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #64b5f6;
    border-bottom: 2px solid #64b5f6;
    padding-bottom: 5px;
}

.setting-item {
    margin-bottom: 15px;
}

.setting-item label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}

.setting-item input,
.setting-item textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.setting-item input:focus,
.setting-item textarea:focus {
    border-color: #64b5f6;
    outline: none;
    box-shadow: 0 0 5px rgba(100, 181, 246, 0.2);
}

.modal input:required {
    border-left: 3px solid #64b5f6;
}

@media (max-width: 768px) {
    .settings-grid {
        grid-template-columns: 1fr !important;
    }
}

.settings-group h3 {
    color: #64b5f6;
    border-bottom: 2px solid #64b5f6;
    padding-bottom: 5px;
    margin-bottom: 15px;
}

.settings-group input[type="text"],
.settings-group input[type="email"],
.settings-group input[type="tel"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    margin-top: 5px;
}

.settings-group input:focus {
    border-color: #64b5f6;
    outline: none;
    box-shadow: 0 0 5px rgba(100, 181, 246, 0.2);
}

.setting-item label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
    text-align: left;
    width: 100%;
}

.setting-item input:required {
    border-left: 3px solid #64b5f6;
}

.setting-item label:after {
    content: "*";
    color: #64b5f6;
    margin-left: 3px;
    display: none;
}

.setting-item input:required + label:after {
    display: inline;
}
</style>
</head>
<body>
<header>
<img src="https://raw.githubusercontent.com/hoedii/3D-Druck-Kostenrechner/main/Logo.png" alt="Logo">
<h1>3D Druck Kostenrechner</h1>
<div class="button-container">
    <button id="downloadBtn" class="download-button" title="Als ZIP herunterladen">
        <div class="button-content">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            <span class="button-text">ZIP</span>
        </div>
    </button>
    <button id="pdfExportBtn" class="pdf-button" title="Als PDF exportieren">
        <div class="button-content">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <span class="button-text">PDF</span>
        </div>
    </button>
    <button id="settingsButton" class="settings-button">
        <div class="button-content">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            <span class="button-text">Einstellungen</span>
        </div>
    </button>
</div>
</header>
<div class="container">
<h2>Dateien hochladen</h2>
<p style="font-size: 12px; color: #777;">Kompatibel sind mit Anycubic Slicer Next geslicete GCode-Dateien (FDM) und PhotonWorkshop geslicete pm4u-Dateien (Resin).</p>
<div class="file-actions">
    <div class="input-section">
        <div class="file-input-group">
            <input type="file" id="gcodeInput" accept=".gcode,.pm4u" multiple style="display: none;">
            <label for="gcodeInput" style="display: block; width: 100%;">
                <div class="custom-file-input">
                    <span class="button-text">Dateien auswählen</span>
                    <span class="file-status" style="color: #666;"></span>
                </div>
            </label>
        </div>
        <div class="file-input-group">
            <input type="file" id="folderInput" accept=".zip" style="display: none;">
            <label for="folderInput" id="selectFolderBtn" style="display: block; width: 100%;">
                <div class="subtle-button">
                    <span class="button-text">ZIP Datei auswählen</span>
                    <span class="folder-status" style="color: #666; margin-left: 10px; font-size: 13px;"></span>
                </div>
            </label>
        </div>
    </div>
</div>
<button id="processButton">Berechnen</button>
<div id="fileInfo"></div>
<button id="clearAllButton" style="display: none;">Alle Ergebnisse löschen</button>
<div class="total-cost-container" id="totalCostContainer">
    <h3>Gesamtkosten</h3>
    <p>Materialkosten: <span id="totalMaterialCost">0.00 CHF</span></p>
    <p>Zeitkosten: <span id="totalTimeCost">0.00 CHF</span></p>
    <p>Stromkosten: <span id="totalEnergyCost">0.00 CHF</span></p>
    <p><strong>Total: <span id="totalCost">0.00 CHF</span></strong></p>
</div>
<div class="export-group">
    <button id="exportBtn" class="export-button">Exportieren</button>
</div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Kosteneinstellungen</h2>
        
        <div class="import-export-buttons">
            <button id="exportSettings">Einstellungen exportieren</button>
            <button id="importSettings">Einstellungen importieren</button>
            <input type="file" id="importFile" accept=".json" style="display: none;">
        </div>

        <div class="settings-grid">
            <div class="settings-group">
                <h3>Zeitkosten</h3>
                <div class="setting-item">
                    <label>Preis pro Stunde (bis 5h)</label>
                    <input type="number" step="0.01" id="time_price_per_hour">
                </div>
                <div class="setting-item">
                    <label>Preis pro Stunde (5-10h)</label>
                    <input type="number" step="0.01" id="time_price_per_hour5">
                </div>
                <div class="setting-item">
                    <label>Preis pro Stunde (über 10h)</label>
                    <input type="number" step="0.01" id="time_price_per_hour10">
                </div>
            </div>

            <div class="settings-group">
                <h3>FDM Materialkosten (pro kg)</h3>
                <div class="setting-item">
                    <label>PLA</label>
                    <input type="number" step="0.01" id="material_price_per_kg_PLA">
                </div>
                <div class="setting-item">
                    <label>ABS</label>
                    <input type="number" step="0.01" id="material_price_per_kg_ABS">
                </div>
                <div class="setting-item">
                    <label>TPU</label>
                    <input type="number" step="0.01" id="material_price_per_kg_TPU">
                </div>
                <div class="setting-item">
                    <label>PETG</label>
                    <input type="number" step="0.01" id="material_price_per_kg_PETG">
                </div>
                <div class="setting-item">
                    <label>ASA</label>
                    <input type="number" step="0.01" id="material_price_per_kg_ASA">
                </div>
            </div>

            <div class="settings-group">
                <h3>Resin Materialkosten (pro kg)</h3>
                <div class="setting-item">
                    <label>TOUGH RESIN</label>
                    <input type="number" step="0.01" id="material_price_per_kg_TOUGH_RESIN">
                </div>
                <div class="setting-item">
                    <label>ABS LIKE RESIN V2</label>
                    <input type="number" step="0.01" id="material_price_per_kg_ABS_LIKE_RESIN_V2">
                </div>
                <div class="setting-item">
                    <label>ABS LIKE RESIN PRO</label>
                    <input type="number" step="0.01" id="material_price_per_kg_ABS_LIKE_RESIN_PRO">
                </div>
            </div>

            <div class="settings-group">
                <h3>Resin Reinigungskosten</h3>
                <div class="setting-item">
                    <label>TOUGH RESIN</label>
                    <input type="number" step="0.01" id="clean_price_TOUGH_RESIN">
                </div>
                <div class="setting-item">
                    <label>ABS LIKE RESIN PRO</label>
                    <input type="number" step="0.01" id="clean_price_ABS_LIKE_RESIN_PRO">
                </div>
                <div class="setting-item">
                    <label>ABS LIKE RESIN V2</label>
                    <input type="number" step="0.01" id="clean_price_ABS_LIKE_RESIN_V2">
                </div>
            </div>

            <div class="settings-group">
                <h3>Sonstige Kosten</h3>
                <div class="setting-item">
                    <label>Strompreis pro kWh</label>
                    <input type="number" step="0.01" id="energy_price_per_kwh">
                </div>
            </div>

            <div class="settings-group">
                <h3>PDF Absender-Informationen</h3>
                <div class="setting-item">
                    <label>Anrede</label>
                    <input type="text" id="sender_salutation">
                </div>
                <div class="setting-item">
                    <label>Name/Nachname*</label>
                    <input type="text" id="sender_name" required>
                </div>
                <div class="setting-item">
                    <label>Firmenname</label>
                    <input type="text" id="company_name">
                </div>
                <div class="setting-item">
                    <label>Straße*</label>
                    <input type="text" id="company_street" required>
                </div>
                <div class="setting-item">
                    <label>PLZ/Ort*</label>
                    <input type="text" id="company_city" required>
                </div>
                <div class="setting-item">
                    <label>Telefon*</label>
                    <input type="tel" id="company_phone" required>
                </div>
                <div class="setting-item">
                    <label>E-Mail*</label>
                    <input type="email" id="company_email" required>
                </div>
                <div class="setting-item">
                    <label>Bank*</label>
                    <input type="text" id="company_bank" required>
                </div>
                <div class="setting-item">
                    <label>IBAN*</label>
                    <input type="text" id="company_iban" required>
                </div>
                <div class="setting-item">
                    <label>TWINT*</label>
                    <input type="text" id="company_twint" required>
                </div>
                <div class="setting-item">
                    <label>Zahlungsbedingungen</label>
                    <input type="text" id="payment_terms">
                </div>
            </div>
        </div>

        <div class="settings-actions">
            <button id="resetSettings" style="background-color: #ff4d4d;">Zurücksetzen</button>
        </div>
    </div>
</div>

<!-- Recipient Modal -->
<div id="recipientModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="close">&times;</span>
        <h2>Empfänger-Informationen</h2>
        
        <div class="settings-grid" style="grid-template-columns: 1fr;">
            <div class="settings-group">
                <div class="setting-item">
                    <label>Anrede</label>
                    <input type="text" id="recipient_salutation">
                </div>
                <div class="setting-item">
                    <label>Name/Nachname*</label>
                    <input type="text" id="recipient_name" required>
                </div>
                <div class="setting-item">
                    <label>Firmenname</label>
                    <input type="text" id="recipient_company">
                </div>
                <div class="setting-item">
                    <label>Straße*</label>
                    <input type="text" id="recipient_street" required>
                </div>
                <div class="setting-item">
                    <label>PLZ/Ort*</label>
                    <input type="text" id="recipient_city" required>
                </div>
                <div class="setting-item">
                    <label>E-Mail</label>
                    <input type="email" id="recipient_email">
                </div>
                <div class="setting-item">
                    <label>Telefon</label>
                    <input type="tel" id="recipient_phone">
                </div>
                <div class="setting-item">
                    <label>Bemerkungen</label>
                    <textarea id="recipient_notes" rows="3" style="width: 100%; padding: 8px;"></textarea>
                </div>
            </div>
        </div>

        <p style="color: #666; font-size: 12px; margin-top: 10px;">* Pflichtfelder</p>

        <div class="settings-actions">
            <button id="cancelPdfBtn" style="background-color: #999;">Abbrechen</button>
            <button id="confirmPdfBtn" style="background-color: #64b5f6;">PDF erstellen</button>
        </div>
    </div>
</div>

<script>
// Globale Variablen
let selectedFiles = [];
let originalFiles = [];  // Array für die Original-Dateien

const costConfig = {
    time_price_per_hour: 2.75,
    time_price_per_hour5: 1.75,
    time_price_per_hour10: 1.1,
    material_price_per_kg_PLA: 25.0,
    material_price_per_kg_ABS: 23.0,
    material_price_per_kg_TPU: 28.0,
    material_price_per_kg_PETG: 18.0,
    material_price_per_kg_ASA: 32.0,
    material_price_per_kg_TOUGH_RESIN: 56.0,
    material_price_per_kg_ABS_LIKE_RESIN_V2: 35.0,
    material_price_per_kg_ABS_LIKE_RESIN_PRO: 40.0,
    energy_price_per_kwh: 0.40,
    clean_price_TOUGH_RESIN: 5.0,
    clean_price_ABS_LIKE_RESIN_PRO: 5.0,
    clean_price_ABS_LIKE_RESIN_V2: 3.0,
    // Absender-Informationen
    sender_salutation: "",
    sender_name: "",
    company_name: "",
    company_street: "",
    company_city: "",
    company_phone: "",
    company_email: "",
    company_iban: "",
    company_bank: "",
    company_twint: "",
    payment_terms: "Zahlbar innerhalb von 30 Tagen",
    // Empfänger-Informationen
    recipient_salutation: "",
    recipient_name: "",
    recipient_company: "",
    recipient_street: "",
    recipient_city: "",
    recipient_email: "",
    recipient_phone: "",
    recipient_notes: ""
};

// Füge die Empfängerfelder zu den Einstellungen hinzu
document.querySelector('.settings-grid').insertAdjacentHTML('beforeend', `
    <div class="settings-group">
        <h3>Standard-Empfänger</h3>
        <p style="color: #666; font-size: 12px; margin-bottom: 15px;">Diese Informationen werden als Vorschlag im PDF-Dialog angezeigt.</p>
        <div class="setting-item">
            <label>Anrede</label>
            <input type="text" id="recipient_salutation">
        </div>
        <div class="setting-item">
            <label>Name/Nachname</label>
            <input type="text" id="recipient_name">
        </div>
        <div class="setting-item">
            <label>Firmenname</label>
            <input type="text" id="recipient_company">
        </div>
        <div class="setting-item">
            <label>Straße</label>
            <input type="text" id="recipient_street">
        </div>
        <div class="setting-item">
            <label>PLZ/Ort</label>
            <input type="text" id="recipient_city">
        </div>
        <div class="setting-item">
            <label>E-Mail</label>
            <input type="email" id="recipient_email">
        </div>
        <div class="setting-item">
            <label>Telefon</label>
            <input type="tel" id="recipient_phone">
        </div>
        <div class="setting-item">
            <label>Standard-Bemerkungen</label>
            <textarea id="recipient_notes" rows="3" style="width: 100%; padding: 8px;"></textarea>
        </div>
    </div>
`);

// Standardeinstellungen als Referenz
const defaultSettings = { ...costConfig };

// Lade gespeicherte Einstellungen wenn sie existieren
const savedSettings = localStorage.getItem('costSettings');
if (savedSettings) {
    try {
        const parsedSettings = JSON.parse(savedSettings);
        Object.assign(costConfig, parsedSettings);
    } catch (e) {
        console.error("Error loading settings:", e);
    }
}

let allResults = [];
const savedResults = localStorage.getItem('savedResults');
if (savedResults) {
    try {
        allResults = JSON.parse(savedResults);
        allResults = allResults.filter(result => 
            result && 
            result.fileName && 
            result.materialCost !== undefined && 
            result.timeCost !== undefined && 
            result.energyCost !== undefined
        );
    } catch (e) {
        console.error("Error loading results from localStorage:", e);
        localStorage.removeItem('savedResults');
        allResults = [];
    }
}

// Initialisiere die Seite wenn das DOM geladen ist
document.addEventListener('DOMContentLoaded', function() {
    initializeSettingsInputs();
    if (allResults.length > 0) {
        recalculateAllResults();
    }
});

function recalculateAllResults() {
    const currentResults = [...allResults];
    allResults = [];
    currentResults.forEach(result => {
        if (result.type === 'gcode') {
            const printTime = convertTimeToHours(result.printTimeStr);
            const pricePerKg = costConfig[`material_price_per_kg_${result.materialType.toUpperCase()}`] || 0;
            
            // Recalculate material cost
            result.materialCost = result.usedFilament / 1000 * pricePerKg;
            result.materialTooltip = `Gewicht (${(result.usedFilament).toFixed(2)} g) * Preis pro kg (${pricePerKg.toFixed(2)} CHF/kg) = ${result.materialCost.toFixed(2)} CHF`;
            
            // Recalculate time cost
            let timeCost = 0;
            let timePricePerHour = 0;
            if (printTime > 0) {
                if (printTime <= 5) {
                    timeCost = printTime * costConfig.time_price_per_hour;
                    timePricePerHour = costConfig.time_price_per_hour;
                } else if (printTime <= 10) {
                    timeCost = printTime * costConfig.time_price_per_hour5;
                    timePricePerHour = costConfig.time_price_per_hour5;
                } else {
                    timeCost = printTime * costConfig.time_price_per_hour10;
                    timePricePerHour = costConfig.time_price_per_hour10;
                }
            }
            result.timeCost = timeCost;
            result.timeTooltip = `Druckzeit (${printTime.toFixed(2)}h) * Stundenansatz (${timePricePerHour.toFixed(2)} CHF/h) = ${timeCost.toFixed(2)} CHF`;
            
            // Recalculate energy cost
            result.energyCost = printTime * 0.25 * costConfig.energy_price_per_kwh;
            result.energyTooltip = `Druckzeit (${printTime.toFixed(2)}h) * Verbrauch (0.25 kW) * Preis (${costConfig.energy_price_per_kwh.toFixed(2)} CHF/kWh) = ${result.energyCost.toFixed(2)} CHF`;
            
        } else if (result.type === 'pm4u') {
            const printTimeHours = result.printTimeStr ? convertTimeToHours(result.printTimeStr) : 0;
            const materialConfigKey = 'material_price_per_kg_' + result.materialType.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase();
            const configPricePerKg = costConfig[materialConfigKey];
            const resinDensity = 1.1;
            
            // Recalculate material cost
            if (typeof configPricePerKg === 'number' && configPricePerKg > 0 && result.volume > 0) {
                const volumeInLitres = result.volume / 1000;
                const massInKg = volumeInLitres * resinDensity;
                result.materialCost = massInKg * configPricePerKg;
                result.materialTooltip = `Gewicht (${(result.volume * resinDensity).toFixed(2)} g) * Preis pro kg (${configPricePerKg.toFixed(2)} CHF/kg) = ${result.materialCost.toFixed(2)} CHF`;
            }
            
            // Recalculate time cost
            let baseTimeCost = 0;
            let timePricePerHour = 0;
            if (printTimeHours > 0) {
                if (printTimeHours <= 5) {
                    baseTimeCost = printTimeHours * costConfig.time_price_per_hour;
                    timePricePerHour = costConfig.time_price_per_hour;
                } else if (printTimeHours <= 10) {
                    baseTimeCost = printTimeHours * costConfig.time_price_per_hour5;
                    timePricePerHour = costConfig.time_price_per_hour5;
                } else {
                    baseTimeCost = printTimeHours * costConfig.time_price_per_hour10;
                    timePricePerHour = costConfig.time_price_per_hour10;
                }
            }
            
            const cleanPriceKey = 'clean_price_' + result.materialType.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase();
            const cleanPrice = costConfig[cleanPriceKey] || 0;
            result.timeCost = baseTimeCost + cleanPrice;
            result.timeTooltip = `Druckzeit (${printTimeHours.toFixed(2)}h) * Stundenansatz (${timePricePerHour.toFixed(2)} CHF/h) + Reinigung (${cleanPrice.toFixed(2)} CHF) = ${result.timeCost.toFixed(2)} CHF`;
            
            // Recalculate energy cost
            result.energyCost = printTimeHours * 0.25 * costConfig.energy_price_per_kwh;
            result.energyTooltip = `Druckzeit (${printTimeHours.toFixed(2)}h) * Verbrauch (0.25 kW) * Preis (${costConfig.energy_price_per_kwh.toFixed(2)} CHF/kWh) = ${result.energyCost.toFixed(2)} CHF`;
        }
        
        result.totalFileCost = result.materialCost + result.timeCost + result.energyCost;
        allResults.push(result);
    });
    
    renderResults();
}

// Settings Modal Functionality
const modal = document.getElementById("settingsModal");
const settingsBtn = document.getElementById("settingsButton");
const closeBtn = document.getElementsByClassName("close")[0];
const saveSettingsBtn = document.getElementById("saveSettings");
const resetSettingsBtn = document.getElementById("resetSettings");
const exportSettingsBtn = document.getElementById("exportSettings");
const importSettingsBtn = document.getElementById("importSettings");
const importFileInput = document.getElementById("importFile");

// Initialize settings inputs with current values and highlight changes
function initializeSettingsInputs() {
    for (const [key, value] of Object.entries(costConfig)) {
        const input = document.getElementById(key);
        if (input) {
            // Erstelle einen Container für Input und Reset-Button
            const container = input.parentElement;
            
            // Erstelle Reset-Button falls noch nicht vorhanden
            let resetButton = container.querySelector('.reset-button');
            if (!resetButton) {
                resetButton = document.createElement('button');
                resetButton.className = 'reset-button';
                resetButton.innerHTML = '↺';
                resetButton.title = 'Auf Standardwert zurücksetzen';
                container.appendChild(resetButton);
            }

            // Setze den aktuellen Wert
            input.value = value;
            
            // Prüfe initial ob der Wert vom Standard abweicht
            if (typeof value === 'number') {
                if (Math.abs(value - defaultSettings[key]) > 0.001) {
                    input.style.color = '#ff0000';
                    container.classList.add('changed');
                } else {
                    input.style.color = '#000000';
                    container.classList.remove('changed');
                }
            } else if (value !== defaultSettings[key]) {
                container.classList.add('changed');
            } else {
                container.classList.remove('changed');
            }
            
            // Event Listener für Änderungen
            input.addEventListener('input', function() {
                if (typeof value === 'number') {
                    // Für numerische Werte
                    const newValue = parseFloat(this.value);
                    if (!isNaN(newValue)) {
                        if (Math.abs(newValue - defaultSettings[key]) > 0.001) {
                            this.style.color = '#ff0000';
                            container.classList.add('changed');
                        } else {
                            this.style.color = '#000000';
                            container.classList.remove('changed');
                        }
                        costConfig[key] = newValue;
                    }
                } else {
                    // Für Text-Werte
                    costConfig[key] = this.value;
                    if (this.value !== defaultSettings[key]) {
                        container.classList.add('changed');
                    } else {
                        container.classList.remove('changed');
                    }
                }
                localStorage.setItem('costSettings', JSON.stringify(costConfig));
                
                // Wenn es sich um einen numerischen Wert handelt, Berechnungen aktualisieren
                if (typeof value === 'number') {
                    recalculateAllResults();
                }
            });

            // Event Listener für Reset-Button
            resetButton.addEventListener('click', function(e) {
                e.preventDefault();
                const defaultValue = defaultSettings[key];
                input.value = defaultValue;
                costConfig[key] = defaultValue;
                
                if (typeof value === 'number') {
                    input.style.color = '#000000';
                }
                container.classList.remove('changed');
                
                localStorage.setItem('costSettings', JSON.stringify(costConfig));
                
                // Wenn es sich um einen numerischen Wert handelt, Berechnungen aktualisieren
                if (typeof value === 'number') {
                    recalculateAllResults();
                }
            });
        }
    }
}

// Event Listeners for Settings Modal
settingsBtn.onclick = () => {
    initializeSettingsInputs();
    modal.style.display = "block";
};

closeBtn.onclick = () => {
    modal.style.display = "none";
};

window.onclick = (event) => {
    if (event.target == modal) {
        modal.style.display = "none";
    }
};

// Reset settings to default values
resetSettingsBtn.onclick = () => {
    Object.assign(costConfig, defaultSettings);
    localStorage.setItem('costSettings', JSON.stringify(costConfig));
    initializeSettingsInputs();
    recalculateAllResults();
};

// Verstecke den grauen Export-Button in der UI
document.getElementById('exportBtn').style.display = 'none';

// Funktion zum Filtern der verwendeten Einstellungen
function getFilteredSettings() {
    const usedSettings = [
        'time_price_per_hour',
        'time_price_per_hour5',
        'time_price_per_hour10',
        'material_price_per_kg_PLA',
        'material_price_per_kg_ABS',
        'material_price_per_kg_TPU',
        'material_price_per_kg_PETG',
        'material_price_per_kg_ASA',
        'material_price_per_kg_TOUGH_RESIN',
        'material_price_per_kg_ABS_LIKE_RESIN_V2',
        'material_price_per_kg_ABS_LIKE_RESIN_PRO',
        'energy_price_per_kwh',
        'clean_price_TOUGH_RESIN',
        'clean_price_ABS_LIKE_RESIN_PRO',
        'clean_price_ABS_LIKE_RESIN_V2',
        'sender_salutation',
        'sender_name',
        'company_name',
        'company_street',
        'company_city',
        'company_phone',
        'company_email',
        'company_bank',
        'company_iban',
        'company_twint',
        'payment_terms',
        'recipient_salutation',
        'recipient_name',
        'recipient_company',
        'recipient_street',
        'recipient_city',
        'recipient_email',
        'recipient_phone',
        'recipient_notes'
    ];
    
    const exportSettings = {};
    usedSettings.forEach(key => {
        if (costConfig[key] !== undefined) {
            exportSettings[key] = costConfig[key];
        }
    });
    return exportSettings;
}

// Export settings Button
exportSettingsBtn.onclick = () => {
    const settingsJson = JSON.stringify(getFilteredSettings(), null, 2);
    const blob = new Blob([settingsJson], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'einstellungen.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};

// Import settings
importSettingsBtn.onclick = () => importFileInput.click();
importFileInput.onchange = async (event) => {
    const file = event.target.files[0];
    if (file) {
        await loadSettingsFromFile(file);
    }
    event.target.value = '';
};

function renderResults() {
    const fileInfoDiv = document.getElementById('fileInfo');
    fileInfoDiv.innerHTML = '';
    allResults.forEach(result => {
        if (!result || !result.fileName) return;
        let outputHtml = '';
        const cleanFileName = result.fileName.replace(/[^a-zA-Z0-9]/g, '');
        const idPrefix = result.type === 'gcode' ? 'gcode-' : 'pm4u-';
        const volumeOrFilamentDisplay = result.type === 'gcode'
            ? `<p><strong>Verwendetes Filament:</strong> ${result.usedFilament !== null ? result.usedFilament.toFixed(2) + ' g' : 'N/A'}</p>`
            : `<p><strong>Verwendetes Resin:</strong> ${result.volume !== null ? (result.volume * 1.15).toFixed(2) + ' g' : 'N/A'}</p>`;
        const timeCostLabel = result.type === 'pm4u' ? 'Zeitkosten (inkl. Reinigung)' : 'Zeitkosten';
        outputHtml = `
        <div class="gcode-result" id="${idPrefix}${cleanFileName}_${result.id}">
        <div class="accordion"><span>${result.fileName}</span></div>
        <div class="panel">
        <p><strong>Materialtyp:</strong> ${result.materialType || 'Unbekannt'}</p>
        ${volumeOrFilamentDisplay}
        <p><strong>Druckzeit:</strong> ${result.printTimeStr || 'Unbekannt'}</p>
        <p title="${result.materialTooltip || ''}"><strong>Materialkosten:</strong> ${result.materialCost !== undefined ? result.materialCost.toFixed(2) + ' CHF' : 'N/A'}</p>
        <p title="${result.timeTooltip || ''}"><strong>${timeCostLabel}:</strong> ${result.timeCost !== undefined ? result.timeCost.toFixed(2) + ' CHF' : 'N/A'}</p>
        <p title="${result.energyTooltip || ''}"><strong>Stromkosten:</strong> ${result.energyCost !== undefined ? result.energyCost.toFixed(2) + ' CHF' : 'N/A'}</p>
        <p><strong>Gesamtkosten:</strong> ${result.totalFileCost !== undefined ? result.totalFileCost.toFixed(2) + ' CHF' : 'N/A'}</p>
        <button class="delete-button" onclick="deleteResult(this, '${result.fileName.replace(/'/g, "\\'").replace(/"/g, '\\"')}', '${result.id}')">Löschen</button>
        </div>
        </div>
        `;
        fileInfoDiv.insertAdjacentHTML('beforeend', outputHtml);
    });
    updateTotalCosts();
    addAccordionListeners();

    // Zeige oder verstecke Buttons basierend auf vorhandenen Ergebnissen
    const hasResults = allResults.length > 0;
    
    // PDF und Download Buttons
    document.getElementById('downloadBtn').style.display = hasResults ? 'flex' : 'none';
    document.getElementById('pdfExportBtn').style.display = hasResults ? 'flex' : 'none';
    
    // Andere UI-Elemente
    document.getElementById('clearAllButton').style.display = hasResults ? 'block' : 'none';
    document.getElementById('totalCostContainer').style.display = hasResults ? 'block' : 'none';
}

function convertTimeToHours(timeStr) {
    const timeMatch = timeStr.match(/(?:(\d+)d)?\s*(?:(\d+)h)?\s*(?:(\d+)m)?\s*(?:(\d+)s)?/);
    if (timeMatch) {
        const days = parseInt(timeMatch[1] || 0, 10);
        const hours = parseInt(timeMatch[2] || 0, 10);
        const minutes = parseInt(timeMatch[3] || 0, 10);
        const seconds = parseInt(timeMatch[4] || 0, 10);
        return days * 24 + hours + minutes / 60 + seconds / 3600;
    }
    return 0;
}

function formatTimeFromSeconds(totalSeconds) {
    if (isNaN(totalSeconds) || totalSeconds < 0) return 'Unbekannt';
    const days = Math.floor(totalSeconds / (3600 * 24));
    const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = Math.floor(totalSeconds % 60);
    let timeStr = '';
    if (days > 0) timeStr += `${days}d `;
    if (hours > 0 || days > 0) timeStr += `${hours}h `;
    if (minutes > 0 || hours > 0 || days > 0) timeStr += `${minutes}m `;
    if (seconds > 0 || timeStr === '') timeStr += `${seconds}s`;
    return timeStr.trim();
}

function updateTotalCosts() {
    let totalMaterialCost = 0, totalTimeCost = 0, totalEnergyCost = 0;
    allResults.forEach(result => {
        totalMaterialCost += result.materialCost || 0;
        totalTimeCost += result.timeCost || 0;
        totalEnergyCost += result.energyCost || 0;
    });
    const totalCost = totalMaterialCost + totalTimeCost + totalEnergyCost;
    document.getElementById('totalMaterialCost').textContent = totalMaterialCost.toFixed(2) + ' CHF';
    document.getElementById('totalTimeCost').textContent = totalTimeCost.toFixed(2) + ' CHF';
    document.getElementById('totalEnergyCost').textContent = totalEnergyCost.toFixed(2) + ' CHF';
    document.getElementById('totalCost').textContent = totalCost.toFixed(2) + ' CHF';
    document.getElementById('totalCostContainer').style.display = totalCost > 0 ? 'block' : 'none';
    document.getElementById('clearAllButton').style.display = totalCost > 0 ? 'block' : 'none';
}

function deleteResult(button, fileName, resultId) {
    const resultDiv = button.closest('.gcode-result');
    if (resultDiv) resultDiv.remove();
    allResults = allResults.filter(r => r.id !== resultId);
    updateTotalCosts();
    localStorage.setItem('savedResults', JSON.stringify(allResults));
}

function addAccordionListeners() {
    const acc = document.getElementsByClassName('accordion');
    for (let i = 0; i < acc.length; i++) {
        acc[i].removeEventListener('click', toggleAccordion);
        acc[i].addEventListener('click', toggleAccordion);
    }
}

function toggleAccordion() {
    this.classList.toggle('active');
    const panel = this.nextElementSibling;
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
}

function processGCodeFile(file) {
    return new Promise((resolve) => {
        // Generiere eine eindeutige ID für diese Datei
        const uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        // Füge die Datei zu originalFiles hinzu
        if (!originalFiles.includes(file)) {
            originalFiles.push(file);
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            const gcodeText = event.target.result;
            let usedFilament = 0, printTime = 0, materialType = 'PLA', printTimeStr = '';
            const materialMatch = gcodeText.match(/; paint_info = (\[.*\])/);
            if (materialMatch) {
                try {
                    const materialInfo = JSON.parse(materialMatch[1]);
                    if (Array.isArray(materialInfo) && materialInfo.length > 0) {
                        materialType = materialInfo[0].material_type || 'PLA';
                    } else if (materialInfo.material_type) {
                        materialType = materialInfo.material_type;
                    }
                } catch (e) { console.error("Error parsing GCode material info:", e); }
            }
            const filamentMatch = gcodeText.match(/; total filament used \[g\] = (\d+\.\d+)/);
            if (filamentMatch) usedFilament = parseFloat(filamentMatch[1]);
            const timeMatch1 = gcodeText.match(/; print_time = ([\ddhms\s]+)/);
            const timeMatch2 = gcodeText.match(/;TIME:(\d+)/);
            const timeMatch3 = gcodeText.match(/; estimated printing time.*?= ([\dhms\s]+)/i);
            let totalSeconds = 0;
            if (timeMatch1) {
                printTimeStr = timeMatch1[1].trim();
                printTime = convertTimeToHours(printTimeStr);
                totalSeconds = printTime * 3600;
            } else if (timeMatch2) {
                totalSeconds = parseInt(timeMatch2[1], 10);
                printTime = totalSeconds / 3600;
                printTimeStr = formatTimeFromSeconds(totalSeconds);
            } else if (timeMatch3) {
                printTimeStr = timeMatch3[1].trim();
                printTime = convertTimeToHours(printTimeStr);
                totalSeconds = printTime * 3600;
            } else {
                printTimeStr = 'Unbekannt';
                printTime = 0;
                totalSeconds = 0;
            }
            const pricePerKg = costConfig[`material_price_per_kg_${materialType.toUpperCase()}`] || 0;
            const materialCost = usedFilament / 1000 * pricePerKg;
            let timeCost = 0;
            let timePricePerHour = 0;
            if (printTime > 0) {
                if (printTime <= 5) {
                    timeCost = printTime * costConfig.time_price_per_hour;
                    timePricePerHour = costConfig.time_price_per_hour;
                }
                else if (printTime <= 10) {
                    timeCost = printTime * costConfig.time_price_per_hour5;
                    timePricePerHour = costConfig.time_price_per_hour5;
                }
                else {
                    timeCost = printTime * costConfig.time_price_per_hour10;
                    timePricePerHour = costConfig.time_price_per_hour10;
                }
            }
            const materialTooltip = `Gewicht (${(usedFilament).toFixed(2)} g) * Preis pro kg (${pricePerKg.toFixed(2)} CHF/kg) = ${materialCost.toFixed(2)} CHF`;
            let timeTooltipText = 'Druckzeit unbekannt, Zeitkosten 0 CHF';
            if (printTime > 0) { timeTooltipText = `Druckzeit (${printTime.toFixed(2)}h) * Stundenansatz (${timePricePerHour.toFixed(2)} CHF/h) = ${timeCost.toFixed(2)} CHF`; }
            const energyCost = printTime * 0.25 * costConfig.energy_price_per_kwh;
            const energyTooltip = `Druckzeit (${printTime.toFixed(2)}h) * Verbrauch (0.25 kW) * Preis (${costConfig.energy_price_per_kwh.toFixed(2)} CHF/kWh) = ${energyCost.toFixed(2)} CHF`;
            const totalFileCost = materialCost + timeCost + energyCost;
            allResults.push({
                id: uniqueId,
                fileName: file.name,
                type: 'gcode',
                materialType,
                usedFilament,
                volume: null,
                printTimeStr,
                materialCost,
                timeCost,
                energyCost,
                totalFileCost,
                materialTooltip,
                timeTooltip: timeTooltipText,
                energyTooltip
            });
            renderResults();
            localStorage.setItem('savedResults', JSON.stringify(allResults));
            resolve();
        };
        
        reader.onerror = function(e) {
            console.error(`Error reading GCode file ${file.name}:`, e);
            const outputHtml = `
            <div class="gcode-result error" id="gcode-${file.name.replace(/[^a-zA-Z0-9]/g, '')}">
            <div class="accordion"><span>${file.name} - Fehler beim Lesen</span></div>
            <div class="panel">
            <p>Die Datei konnte nicht gelesen werden.</p>
            </div>
            </div>
            `;
            document.getElementById('fileInfo').insertAdjacentHTML('beforeend', outputHtml);
            addAccordionListeners();
            resolve();
        };
        
        reader.readAsText(file);
    });
}

function processPM4UFile(file) {
    return new Promise((resolve) => {
        // Generiere eine eindeutige ID für diese Datei
        const uniqueId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        // Füge die Datei zu originalFiles hinzu
        if (!originalFiles.includes(file)) {
            originalFiles.push(file);
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            const pm4uContent = event.target.result;
            JSZip.loadAsync(pm4uContent).then(function(zip) {
                zip.file("print_info.json").async("string").then(function(printInfoContent) {
                    const printInfo = JSON.parse(printInfoContent);
                    const printTimeSeconds = printInfo.print_time;
                    const volume = printInfo.volume;
                    zip.file("anycubic_photon_resins.pwsp").async("string").then(function(resinsContent) {
                        let materialTypeName = 'Unbekannt';
                        const activeResinsRegex = /"active_resins":\s*\[\s*"([^"]+)"/;
                        const activeResinMatch = resinsContent.match(activeResinsRegex);
                        if (activeResinMatch && activeResinMatch[1]) {
                            materialTypeName = activeResinMatch[1];
                        } else {
                            console.warn("No active_resins found or format unexpected in anycubic_photon_resins.pwsp. Using 'Unbekannt'.");
                        }
                        const printTimeHours = printTimeSeconds / 3600;
                        let baseTimeCost = 0;
                        let timePricePerHour = 0;
                        if (printTimeHours > 0) {
                            if (printTimeHours <= 5) {
                                baseTimeCost = printTimeHours * costConfig.time_price_per_hour;
                                timePricePerHour = costConfig.time_price_per_hour;
                            }
                            else if (printTimeHours <= 10) {
                                baseTimeCost = printTimeHours * costConfig.time_price_per_hour5;
                                timePricePerHour = costConfig.time_price_per_hour5;
                            }
                            else {
                                baseTimeCost = printTimeHours * costConfig.time_price_per_hour10;
                                timePricePerHour = costConfig.time_price_per_hour10;
                            }
                        }
                        const cleanPriceKey = 'clean_price_' + materialTypeName.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase();
                        const cleanPrice = costConfig[cleanPriceKey] || 0;
                        const timeCost = baseTimeCost + cleanPrice;
                        const energyCost = printTimeHours * 0.25 * costConfig.energy_price_per_kwh;
                        let materialPrice = 0;
                        const materialConfigKey = 'material_price_per_kg_' + materialTypeName.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase();
                        const configPricePerKg = costConfig[materialConfigKey];
                        let materialTooltip = 'Materialkosten unbekannt (Preis oder Volumen 0)';
                        const resinDensity = 1.1;
                        if (typeof configPricePerKg === 'number' && configPricePerKg > 0 && volume > 0) {
                            const volumeInLitres = volume / 1000;
                            const massInKg = volumeInLitres * resinDensity;
                            materialPrice = massInKg * configPricePerKg;
                            materialTooltip = `Gewicht (${(volume * resinDensity).toFixed(2)} g) * Preis pro kg (${configPricePerKg.toFixed(2)} CHF/kg) = ${materialPrice.toFixed(2)} CHF`;
                        } else {
                            console.warn(`Resin material "${materialTypeName}" or config price invalid for material cost. Material cost set to 0. Looked for key: ${materialConfigKey}`);
                            materialPrice = 0;
                        }
                        const totalFileCost = materialPrice + timeCost + energyCost;
                        const printTimeStr = formatTimeFromSeconds(printTimeSeconds);
                        const timeTooltip = `Druckzeit (${printTimeHours.toFixed(2)}h) * Stundenansatz (${timePricePerHour.toFixed(2)} CHF/h) + Reinigung (${cleanPrice.toFixed(2)} CHF) = ${timeCost.toFixed(2)} CHF`;
                        const energyTooltip = `Druckzeit (${printTimeHours.toFixed(2)}h) * Verbrauch (0.25 kW) * Preis (${costConfig.energy_price_per_kwh.toFixed(2)} CHF/kWh) = ${energyCost.toFixed(2)} CHF`;
                        allResults.push({
                            id: uniqueId,
                            fileName: file.name,
                            type: 'pm4u',
                            materialType: materialTypeName,
                            usedFilament: null,
                            volume,
                            printTimeStr,
                            materialCost: materialPrice,
                            timeCost,
                            energyCost,
                            totalFileCost,
                            materialTooltip,
                            timeTooltip,
                            energyTooltip
                        });
                        renderResults();
                        localStorage.setItem('savedResults', JSON.stringify(allResults));
                        resolve();
                    }).catch(function(e) {
                        console.error(`Error reading anycubic_photon_resins.pwsp or extracting resin name for ${file.name}:`, e);
                        const outputHtml = `
                        <div class="gcode-result error" id="pm4u-${file.name.replace(/[^a-zA-Z0-9]/g, '')}">
                        <div class="accordion"><span>${file.name} - Fehler bei Resin-Info</span></div>
                        <div class="panel">
                        <p>Fehler beim Lesen der Resin-Informationen aus der Datei.</p>
                        </div>
                        </div>
                        `;
                        document.getElementById('fileInfo').insertAdjacentHTML('beforeend', outputHtml);
                        addAccordionListeners();
                        resolve();
                    });
                }).catch(function(e) {
                    console.error(`Error reading print_info.json for ${file.name}:`, e);
                    const outputHtml = `
                    <div class="gcode-result error" id="pm4u-${file.name.replace(/[^a-zA-Z0-9]/g, '')}">
                    <div class="accordion"><span>${file.name} - Fehler bei Druckinfo</span></div>
                    <div class="panel">
                    <p>Fehler beim Lesen der Druckinformationen (Zeit, Volumen) aus der Datei.</p>
                    </div>
                    </div>
                    `;
                    document.getElementById('fileInfo').insertAdjacentHTML('beforeend', outputHtml);
                    addAccordionListeners();
                    resolve();
                });
            }).catch(function(e) {
                console.error(`Error unzipping pm4u file ${file.name}:`, e);
                const outputHtml = `
                <div class="gcode-result error" id="pm4u-${file.name.replace(/[^a-zA-Z0-9]/g, '')}">
                <div class="accordion"><span>${file.name} - Fehler beim Entpacken</span></div>
                <div class="panel">
                <p>Fehler beim Entpacken der Datei.</p>
                </div>
                </div>
                `;
                document.getElementById('fileInfo').insertAdjacentHTML('beforeend', outputHtml);
                addAccordionListeners();
                resolve();
            });
        };
        
        reader.onerror = function(e) {
            console.error(`Error reading pm4u file ${file.name}:`, e);
            const outputHtml = `
            <div class="gcode-result error" id="pm4u-${file.name.replace(/[^a-zA-Z0-9]/g, '')}">
            <div class="accordion"><span>${file.name} - Fehler beim Lesen</span></div>
            <div class="panel">
            <p>Die Datei konnte nicht gelesen werden.</p>
            </div>
            </div>
            `;
            document.getElementById('fileInfo').insertAdjacentHTML('beforeend', outputHtml);
            addAccordionListeners();
            resolve();
        };
        
        reader.readAsArrayBuffer(file);
    });
}

// Speichere die originalen Dateien
// let originalFiles = [];  // Diese Deklaration entfernen, da sie bereits oben existiert

// Funktion zum Verarbeiten der ausgewählten Dateien
function processSelectedFiles(files) {
    const compatibleFiles = Array.from(files).filter(file => 
        file.name.toLowerCase().endsWith('.gcode') || 
        file.name.toLowerCase().endsWith('.pm4u')
    );
    
    if (compatibleFiles.length === 0) {
        alert("Keine kompatiblen Dateien gefunden. Bitte wählen Sie .gcode oder .pm4u Dateien aus.");
        return;
    }
    
    // Speichere die originalen Dateien
    originalFiles = originalFiles.concat(compatibleFiles);
    
    // Verarbeite jede Datei
    compatibleFiles.forEach(file => {
        if (file.name.toLowerCase().endsWith('.gcode')) {
            processGCodeFile(file);
        } else if (file.name.toLowerCase().endsWith('.pm4u')) {
            processPM4UFile(file);
        }
    });
}

// Funktion zum Aktualisieren des Datei-Status
function updateFileStatus() {
    const fileStatusElement = document.querySelector('.file-status');
    const folderStatusElement = document.querySelector('.folder-status');
    const compatibleFiles = selectedFiles.filter(file => 
        file.name.toLowerCase().endsWith('.gcode') || 
        file.name.toLowerCase().endsWith('.pm4u')
    );
    
    if (compatibleFiles.length === 0) {
        fileStatusElement.textContent = '';
        fileStatusElement.style.color = '#666';
        folderStatusElement.textContent = '';
    } else {
        const gcodeCount = compatibleFiles.filter(f => f.name.toLowerCase().endsWith('.gcode')).length;
        const pm4uCount = compatibleFiles.filter(f => f.name.toLowerCase().endsWith('.pm4u')).length;
        
        let statusText = `${compatibleFiles.length} Datei(en)`;
        if (gcodeCount > 0 || pm4uCount > 0) {
            statusText += ' (';
            if (gcodeCount > 0) {
                statusText += `${gcodeCount} GCode`;
                if (pm4uCount > 0) statusText += ', ';
            }
            if (pm4uCount > 0) {
                statusText += `${pm4uCount} PM4U`;
            }
            statusText += ')';
        }

        // Update status based on last input
        const lastInput = document.getElementById('folderInput').value ? 'folder' : 'file';
        
        if (lastInput === 'folder') {
            fileStatusElement.textContent = '';
            folderStatusElement.textContent = '';
        } else {
            fileStatusElement.textContent = statusText;
            fileStatusElement.style.color = '#4CAF50';
            folderStatusElement.textContent = '';
        }
    }
}

// Event Listener für den File Input
document.getElementById('gcodeInput').addEventListener('change', function(event) {
    // Speichere die Dateien temporär
    selectedFiles = Array.from(event.target.files); // Ersetze vorherige Auswahl bei Datei-Upload
    updateFileStatus();
    // Zurücksetzen des Inputs
    this.value = '';
});

// Event Listener für den Process Button
document.getElementById('processButton').addEventListener('click', function() {
    if (selectedFiles.length > 0) {
        // Verstecke die Dateianzeige
        const fileStatus = document.querySelector('.file-status');
        const folderStatus = document.querySelector('.folder-status');
        if (fileStatus) fileStatus.textContent = '';
        if (folderStatus) folderStatus.textContent = '';
        
        // Verarbeite die Dateien
        processSelectedFiles(selectedFiles);
        
        // Leere die selectedFiles nach der Verarbeitung
        selectedFiles = [];
    } else {
        alert("Bitte wählen Sie zuerst Dateien aus.");
    }
});

// Event Listener für den Folder Input
document.getElementById('folderInput').addEventListener('change', async function(event) {
    const files = Array.from(event.target.files);
    let settingsFound = false;
    
    // Prüfe ob eine ZIP-Datei ausgewählt wurde
    if (files.length === 0 || !files[0].name.toLowerCase().endsWith('.zip')) {
        alert("Bitte wählen Sie eine ZIP-Datei aus.");
        this.value = '';
        return;
    }

    const file = files[0];
    
    try {
        const zip = new JSZip();
        const zipContent = await zip.loadAsync(file);
        
        // Suche nach einstellungen.json
        const settingsFile = zipContent.file('einstellungen.json');
        if (settingsFile) {
            settingsFound = true;
            try {
                const settingsContent = await settingsFile.async('string');
                const settingsBlob = new Blob([settingsContent], {type: 'application/json'});
                await loadSettingsFromFile(settingsBlob);
            } catch (error) {
                console.error("Fehler beim Verarbeiten der Einstellungsdatei:", error);
            }
        }
        
        // Extrahiere und verarbeite GCode und PM4U Dateien
        const compatibleFiles = [];
        zipContent.forEach((relativePath, zipEntry) => {
            if (!zipEntry.dir && (
                relativePath.toLowerCase().endsWith('.gcode') || 
                relativePath.toLowerCase().endsWith('.pm4u')
            )) {
                compatibleFiles.push(zipEntry);
            }
        });
        
        if (compatibleFiles.length === 0 && !settingsFound) {
            throw new Error("Keine kompatiblen Dateien in der ZIP-Datei gefunden. Unterstützte Formate: .gcode, .pm4u");
        }
        
        // Verarbeite die gefundenen Dateien
        for (const zipEntry of compatibleFiles) {
            try {
                const content = await zipEntry.async('blob');
                const file = new File([content], zipEntry.name, {
                    type: zipEntry.name.toLowerCase().endsWith('.gcode') ? 
                          'text/plain' : 'application/octet-stream'
                });
                
                // Füge die Datei zu originalFiles hinzu
                if (!originalFiles.some(f => f.name === file.name)) {
                    originalFiles.push(file);
                }
                
                if (file.name.toLowerCase().endsWith('.gcode')) {
                    await processGCodeFile(file);
                } else if (file.name.toLowerCase().endsWith('.pm4u')) {
                    await processPM4UFile(file);
                }
            } catch (error) {
                console.error(`Fehler beim Verarbeiten der Datei ${zipEntry.name}:`, error);
                alert(`Die Datei ${zipEntry.name} konnte nicht verarbeitet werden: ${error.message}`);
            }
        }
        
        // Aktualisiere die Anzeige
        renderResults();
        updateFileStatus();
        
        // Zeige Erfolgsmeldung
        const fileCount = compatibleFiles.length;
        if (fileCount > 0) {
            alert(`${fileCount} Datei${fileCount !== 1 ? 'en' : ''} erfolgreich verarbeitet.`);
        }
        
    } catch (error) {
        console.error("Fehler beim Verarbeiten der ZIP-Datei:", error);
        alert(error.message || "Fehler beim Verarbeiten der ZIP-Datei. Bitte stellen Sie sicher, dass es sich um eine gültige ZIP-Datei handelt.");
    } finally {
        // Zurücksetzen des Inputs
        this.value = '';
    }
});

// Event Listener für den Export-Button
document.getElementById('downloadBtn').addEventListener('click', async function() {
    try {
        const now = new Date();
        const dateStr = formatDate(now);
        const timeStr = formatTime(now);
        const defaultName = `3D-Druck-Kostenrechnung_${dateStr.replace(/\./g, '-')}_${timeStr.replace(':', '-')}`;
        
        const fileName = prompt('Bitte geben Sie einen Namen für die ZIP-Datei ein:', defaultName);
        if (!fileName) return;
        
        const zip = new JSZip();
        
        // Erstelle ein Objekt zur Verfolgung der Dateinamen und ihrer Häufigkeit
        const fileNameCount = {};
        
        // Füge alle originalen Dateien hinzu
        for (const result of allResults) {
            // Finde die entsprechende Original-Datei
            const originalFile = originalFiles.find(f => f.name === result.fileName);
            if (!originalFile) {
                console.warn(`Original file not found for ${result.fileName}`);
                continue;
            }

            let targetFileName = result.fileName;
            
            // Wenn die Datei mehrfach vorkommt
            fileNameCount[result.fileName] = (fileNameCount[result.fileName] || 0) + 1;
            if (fileNameCount[result.fileName] > 1) {
                const lastDotIndex = result.fileName.lastIndexOf('.');
                const baseName = lastDotIndex > -1 ? result.fileName.substring(0, lastDotIndex) : result.fileName;
                const extension = lastDotIndex > -1 ? result.fileName.substring(lastDotIndex) : '';
                targetFileName = `${baseName}_${fileNameCount[result.fileName]}${extension}`;
            }
            
            try {
                const fileData = await originalFile.arrayBuffer();
                zip.file(targetFileName, fileData);
            } catch (error) {
                console.error(`Error adding file ${targetFileName} to zip:`, error);
            }
        }
        
        // Füge die gefilterten Einstellungen hinzu
        zip.file('einstellungen.json', JSON.stringify(getFilteredSettings(), null, 2));
        
        const zipContent = await zip.generateAsync({type: 'blob'});
        
        // Erstelle einen Download Link
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(zipContent);
        downloadLink.download = fileName + '.zip';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        URL.revokeObjectURL(downloadLink.href);
        
        alert("Die ZIP-Datei wurde erfolgreich erstellt!");
    } catch (error) {
        console.error("Fehler beim Exportieren:", error);
        if (error.name !== 'AbortError') {
            alert("Fehler beim Erstellen der ZIP-Datei.");
        }
    }
});

// Event Listener für den Clear-Button
document.getElementById('clearAllButton').addEventListener('click', () => {
    if (confirm('Möchten Sie wirklich alle Ergebnisse löschen?')) {
        allResults = [];
        originalFiles = [];
        selectedFiles = [];
        document.getElementById('fileInfo').innerHTML = '';
        document.getElementById('downloadBtn').style.display = 'none';
        document.getElementById('clearAllButton').style.display = 'none';
        document.getElementById('totalCostContainer').style.display = 'none';
        updateFileStatus();
        updateTotalCosts();
        localStorage.removeItem('savedResults');
    }
});

// Modifiziere die bestehende Funktion zum Aktualisieren der UI
const originalRenderResults = renderResults;
renderResults = function() {
    originalRenderResults();
    // Zeige die Buttons nur wenn Ergebnisse vorhanden sind
    const hasResults = allResults.length > 0;
    document.getElementById('exportBtn').style.display = hasResults ? 'block' : 'none';
    document.getElementById('clearAllButton').style.display = hasResults ? 'block' : 'none';
    document.getElementById('totalCostContainer').style.display = hasResults ? 'block' : 'none';
    document.getElementById('pdfExportBtn').style.display = hasResults ? 'block' : 'none';
    document.getElementById('downloadBtn').style.display = hasResults ? 'block' : 'none';
};

// Event Handler für Einstellungs-Inputs
function handleSettingInput(event) {
    const input = event.target;
    const value = parseFloat(input.value);
    const key = input.id;
    
    // Prüfe ob der neue Wert vom Standard abweicht
    if (value !== costConfig[key]) {
        input.style.color = 'red';
    } else {
        input.style.color = 'black';
    }
}

// Füge Event Listener zu allen Einstellungs-Inputs hinzu
function addSettingInputListeners() {
    for (const key in costConfig) {
        const input = document.getElementById(key);
        if (input) {
            input.addEventListener('input', handleSettingInput);
        }
    }
}

// Füge einen Event Listener für das Laden der Seite hinzu
document.addEventListener('DOMContentLoaded', function() {
    // Stelle sicher, dass der PDF-Button initial ausgeblendet ist
    document.getElementById('pdfExportBtn').style.display = 'none';
    
    // Lade gespeicherte Einstellungen
    const savedSettings = localStorage.getItem('costSettings');
    if (savedSettings) {
        try {
            const parsedSettings = JSON.parse(savedSettings);
            Object.assign(costConfig, parsedSettings);
            initializeSettingsInputs();
        } catch (e) {
            console.error("Error loading settings:", e);
        }
    }
    
    // Lade gespeicherte Ergebnisse
    const savedResults = localStorage.getItem('savedResults');
    if (savedResults) {
        try {
            allResults = JSON.parse(savedResults);
            allResults = allResults.filter(result => 
                result && 
                result.fileName && 
                result.materialCost !== undefined && 
                result.timeCost !== undefined && 
                result.energyCost !== undefined
            );
            
            // Berechne alle Ergebnisse mit den aktuellen Einstellungen neu
            recalculateAllResults();
            
            // Aktualisiere die Sichtbarkeit der Buttons basierend auf den Ergebnissen
            const hasResults = allResults.length > 0;
            document.getElementById('pdfExportBtn').style.display = hasResults ? 'flex' : 'none';
            document.getElementById('downloadBtn').style.display = hasResults ? 'flex' : 'none';
            document.getElementById('clearAllButton').style.display = hasResults ? 'block' : 'none';
            document.getElementById('totalCostContainer').style.display = hasResults ? 'block' : 'none';
        } catch (e) {
            console.error("Error loading results:", e);
            localStorage.removeItem('savedResults');
            allResults = [];
        }
    }
});

// Funktion zum Laden der Einstellungen aus einer Datei
async function loadSettingsFromFile(file) {
    try {
        const settingsText = await file.text();
        const settings = JSON.parse(settingsText);
        
        // Prüfe ob die Einstellungen ein Objekt sind
        if (typeof settings !== 'object' || settings === null) {
            throw new Error("Die Einstellungsdatei enthält kein gültiges JSON-Objekt.");
        }

        // Liste der erforderlichen Einstellungen
        const requiredSettings = [
            'time_price_per_hour',
            'time_price_per_hour5',
            'time_price_per_hour10',
            'material_price_per_kg_PLA',
            'material_price_per_kg_ABS',
            'material_price_per_kg_TPU',
            'material_price_per_kg_PETG',
            'material_price_per_kg_ASA',
            'material_price_per_kg_TOUGH_RESIN',
            'material_price_per_kg_ABS_LIKE_RESIN_V2',
            'material_price_per_kg_ABS_LIKE_RESIN_PRO',
            'energy_price_per_kwh',
            'clean_price_TOUGH_RESIN',
            'clean_price_ABS_LIKE_RESIN_PRO',
            'clean_price_ABS_LIKE_RESIN_V2'
        ];

        // Prüfe jede erforderliche Einstellung
        const missingSettings = requiredSettings.filter(key => !(key in settings));
        const invalidSettings = requiredSettings.filter(key => 
            key in settings && (typeof settings[key] !== 'number' || isNaN(settings[key]))
        );

        if (missingSettings.length > 0) {
            throw new Error(`Fehlende Einstellungen: ${missingSettings.join(', ')}`);
        }

        if (invalidSettings.length > 0) {
            throw new Error(`Ungültige Werte für: ${invalidSettings.join(', ')}`);
        }

        // Wenn alle Prüfungen bestanden wurden, Einstellungen übernehmen
        Object.assign(costConfig, settings);
        localStorage.setItem('costSettings', JSON.stringify(costConfig));
        
        // UI aktualisieren
        initializeSettingsInputs();
        
        // Berechnungen aktualisieren
        if (allResults.length > 0) {
            recalculateAllResults();
        }

        return true;
    } catch (error) {
        console.error("Fehler beim Laden der Einstellungen:", error);
        
        // Detaillierte Fehlermeldung für den Benutzer
        let errorMessage = "Fehler beim Laden der Einstellungen:\n";
        if (error instanceof SyntaxError) {
            errorMessage += "Die Datei enthält kein gültiges JSON-Format.";
        } else {
            errorMessage += error.message;
        }
        
        alert(errorMessage);
        return false;
    }
}

// Funktion zum Generieren des QR-Code Strings
function generateQRString(formData, totalAmount, documentNumber) {
    // Remove spaces from IBAN
    const iban = (formData.company_iban || costConfig.company_iban || '').replace(/\s+/g, '');
    
    // Function to split street and house number
    function splitStreetAndNumber(address) {
        if (!address) return { street: '', number: '' };
        const match = address.match(/(.*?)\s*(\d+\s*[a-zA-Z]?)\s*$/);
        if (match) {
            return {
                street: match[1].trim(),
                number: match[2].trim()
            };
        }
        return { street: address.trim(), number: '' };
    }

    // Split creditor address
    const creditorAddress = splitStreetAndNumber(formData.company_street || costConfig.company_street);
    
    // Split debtor address
    const debtorAddress = splitStreetAndNumber(formData.recipient_street);
    
    const qrData = [
        'SPC',                                          // 01: Header
        '0200',                                         // 02: Version
        '1',                                            // 03: Coding Type
        iban,                                           // 04: IBAN (without spaces)
        'S',                                           // 05: Creditor Address Type
        formData.sender_name || costConfig.sender_name, // 06: Creditor Name
        creditorAddress.street,                         // 07: Creditor Street
        creditorAddress.number,                         // 08: Creditor House Number
        formData.company_city.split(' ')[0] || '',     // 09: Creditor Postal Code
        formData.company_city.split(' ').slice(1).join(' ') || '', // 10: Creditor Town
        'CH',                                          // 11: Creditor Country
        '',                                            // 12: UCR
        '',                                            // 13: Reserved
        '',                                            // 14: Reserved
        '',                                            // 15: Reserved
        '',                                            // 16: Reserved
        '',                                            // 17: Reserved
        '',                                            // 18: Reserved
        totalAmount.toFixed(2),                        // 19: Amount
        'CHF',                                         // 20: Currency
        'S',                                           // 21: Debtor Address Type
        formData.recipient_name,                       // 22: Debtor Name
        debtorAddress.street,                          // 23: Debtor Street
        debtorAddress.number,                          // 24: Debtor House Number
        formData.recipient_city.split(' ')[0] || '',   // 25: Debtor Postal Code
        formData.recipient_city.split(' ').slice(1).join(' ') || '', // 26: Debtor Town
        'CH',                                          // 27: Debtor Country
        'NON',                                         // 28: Reference Type
        '',                                            // 29: Reference (empty)
        '3D Druck Kostenrechnung',                     // 30: Unstructured Message
        'EPD'                                          // 31: EPD
    ].join('\n');

    return qrData;
}

// Modifiziere die exportToPDF Funktion
function exportToPDF(formData = {}) {
    if (allResults.length === 0) {
        alert("Keine Positionen zum Exportieren vorhanden.");
        return;
    }

    // Initialisiere jsPDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Generiere Datum und Dokumentennummer
    const currentDate = new Date();
    const currentDateStr = formatDate(currentDate);
    const currentTimeStr = formatTime(currentDate);

    // Lade und füge das Logo hinzu
    const img = new Image();
    img.src = "https://raw.githubusercontent.com/hoedii/3D-Druck-Kostenrechner/main/Logo.png";
    
    img.onload = function() {
        // Definiere eine moderne Farbpalette
        const colors = {
            primary: [100, 181, 246],      // Ein helleres Blau (#64b5f6)
            secondary: [80, 80, 80],      // Dunkelgrau für Text
            accent: [236, 240, 241],      // Helles Grau für Hintergründe
            stripe: [144, 202, 249]        // Noch helleres Blau für den Streifen (#90caf9)
        };

        // Global layout variables
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        const margin = 20;
        const imgWidth = 18;
        const imgHeight = (img.height * imgWidth) / img.width;
        const startX = 13; // Logo etwas weiter nach rechts, damit es auf dem Streifen sitzt

        // Füge einen subtilen grauen Hintergrund für den Header hinzu
        doc.setFillColor(colors.accent[0], colors.accent[1], colors.accent[2]);
        doc.rect(0, 0, pageWidth, 35, 'F');

        // Füge den farbigen Akzentstreifen hinzu
        doc.setFillColor(colors.stripe[0], colors.stripe[1], colors.stripe[2]);
        doc.rect(0, 0, 45, 35, 'F');

        // Berechne die Positionen für ein ausgewogenes Layout
        const titleX = startX + imgWidth + 25; // Mehr Abstand zwischen Logo und Text
        
        // Setze die Schriftart für den Titel
        doc.setTextColor(colors.primary[0], colors.primary[1], colors.primary[2]);
        doc.setFontSize(24);
        doc.setFont("helvetica", "bold");
        const titleWidth = doc.getTextWidth("3D Druck");
        
        // Füge das Logo hinzu
        doc.addImage(img, 'PNG', startX, 8, imgWidth, imgHeight);

        // Füge den Titel in zwei Zeilen hinzu für bessere Lesbarkeit
        doc.text("3D Druck", titleX, 17);
        doc.setFontSize(14);
        doc.setTextColor(colors.secondary[0], colors.secondary[1], colors.secondary[2]);
        doc.text("Kostenrechnung", titleX, 25);

        // Füge eine subtile Trennlinie hinzu
        doc.setDrawColor(colors.primary[0], colors.primary[1], colors.primary[2]);
        doc.setLineWidth(0.5);
        doc.line(margin, 36, pageWidth - margin, 36);

        // Rest des PDFs entsprechend nach unten verschieben
        doc.setTextColor(colors.secondary[0], colors.secondary[1], colors.secondary[2]);
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        
        // Absender Details
        doc.text("Absender:", margin, 50);
        doc.setFont("helvetica", "bold");
        const senderSalutation = formData.sender_salutation || costConfig.sender_salutation;
        const senderName = formData.sender_name || costConfig.sender_name;
        const companyName = formData.company_name || costConfig.company_name;
        const displayName = (senderSalutation ? senderSalutation + " " : "") + senderName + (companyName ? `, ${companyName}` : '');
        doc.text(displayName, margin, 55);
        doc.setFont("helvetica", "normal");
        doc.text([
            formData.company_street || costConfig.company_street,
            formData.company_city || costConfig.company_city,
            `Tel: ${formData.company_phone || costConfig.company_phone}`,
            `E-Mail: ${formData.company_email || costConfig.company_email}`
        ], margin, 60);

        // Dokumentendetails rechts ausgerichtet
        const detailsX = pageWidth - margin;
        doc.setFontSize(10);
        doc.text([
            `Dokumenten-Nr.: ${generateDocumentNumber()}`,
            `Datum: ${currentDateStr}`,
            `Zeit: ${currentTimeStr}`
        ], detailsX, 50, { align: 'right' });

        // Empfänger Details
        doc.text("Empfänger:", margin, 80);
        doc.setFont("helvetica", "bold");
        const recipientSalutation = formData.recipient_salutation || "Sehr geehrte Damen und Herren";
        const recipientName = formData.recipient_name || "Bitte Empfänger angeben";
        const recipientCompany = formData.recipient_company || "";
        const displayRecipientName = (recipientSalutation ? recipientSalutation + " " : "") + recipientName + (recipientCompany ? `, ${recipientCompany}` : '');
        doc.text(displayRecipientName, margin, 85);
        doc.setFont("helvetica", "normal");
        doc.text([
            formData.recipient_street || "Straße",
            formData.recipient_city || "PLZ/Ort",
            formData.recipient_phone ? `Tel: ${formData.recipient_phone}` : null,
            formData.recipient_email ? `E-Mail: ${formData.recipient_email}` : null
        ].filter(Boolean), margin, 90);

        // Betreff
        doc.setFont("helvetica", "bold");
        doc.text("Kostenaufstellung 3D-Druck", margin, 110);
        doc.setFont("helvetica", "normal");

        // Erstelle die Tabellendaten
        const tableData = allResults.map((result, index) => [
            (index + 1).toString(),
            result.fileName,
            result.materialType || 'Unbekannt',
            result.type === 'gcode' ? 
                (result.usedFilament ? result.usedFilament.toFixed(2) + ' g' : 'N/A') :
                (result.volume ? (result.volume * 1.15).toFixed(2) + ' g' : 'N/A'),
            result.totalFileCost ? result.totalFileCost.toFixed(2) + ' CHF' : 'N/A'
        ]);

        // Berechne Gesamtsummen
        const totalCost = allResults.reduce((sum, result) => sum + (result.totalFileCost || 0), 0);
        
        // Berechne die benötigte Höhe für den Zahlungsbereich
        const paymentSectionHeight = 120; // Ungefähre Höhe des Zahlungsbereichs
        const footerHeight = 10; // Höhe des Footers
        const minBottomMargin = 6; // Minimaler Abstand zum unteren Seitenrand
        const separatorLineMargin = 12; // Abstand des Trennstrichs zum Zahlungsbereich

        // Berechne die Position für den Zahlungsbereich am unteren Rand der ersten Seite
        const paymentY = pageHeight - paymentSectionHeight - footerHeight - minBottomMargin + 60;
        const separatorY = paymentY - separatorLineMargin + 5;

        // Füge die Tabelle hinzu mit maxHeight, damit sie nicht in den Zahlungsbereich überläuft
        doc.autoTable({
            head: [['Pos', 'Dateiname', 'Material', 'Gewicht', 'Gesamtkosten']],
            body: tableData,
            startY: 115,
            margin: { left: margin, right: margin },
            styles: {
                fontSize: 9,
                cellPadding: 3,
                lineColor: [200, 200, 200],
                lineWidth: 0.1,
                font: "helvetica"
            },
            headStyles: {
                fillColor: colors.primary,
                textColor: [255, 255, 255],
                fontSize: 10,
                fontStyle: 'bold',
                halign: 'left'
            },
            columnStyles: {
                0: { cellWidth: 15, halign: 'center' },
                1: { cellWidth: 'auto' },
                2: { cellWidth: 30 },
                3: { cellWidth: 30, halign: 'right' },
                4: { cellWidth: 35, halign: 'right' }
            },
            alternateRowStyles: {
                fillColor: [250, 250, 250]
            },
            pageBreak: 'auto',
            showFoot: 'lastPage',
            didDrawPage: function(data) {
                // Nur auf der ersten Seite den Zahlungsbereich hinzufügen
                if (data.pageNumber === 1) {
                    // Verhindere, dass die Tabelle in den Zahlungsbereich läuft
                    if (data.cursor.y > separatorY - 20) {
                        doc.addPage();
                    }
                }
            }
        });

        // Füge Gesamtsumme hinzu
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.setFont("helvetica", "bold");
        
        const leftColumnX = pageWidth - 65;
        doc.text("Gesamtkosten:", leftColumnX, doc.lastAutoTable.finalY + 8);
        doc.text(`${totalCost.toFixed(2)} CHF`, pageWidth - margin, doc.lastAutoTable.finalY + 8, { align: 'right' });

        // Optional: Füge Bemerkungen hinzu wenn vorhanden
        let notesOffset = 0;
        if (formData.recipient_notes) {
            doc.setTextColor(colors.secondary[0], colors.secondary[1], colors.secondary[2]);
            doc.setFont("helvetica", "bold");
            doc.text("Bemerkungen:", margin, doc.lastAutoTable.finalY + 35);
            doc.setFont("helvetica", "normal");
            const splitNotes = doc.splitTextToSize(formData.recipient_notes, 180);
            doc.text(splitNotes, margin, doc.lastAutoTable.finalY + 42);
            notesOffset = splitNotes.length * 7 + 20;
        }

        // Gehe zurück zur ersten Seite für den Zahlungsbereich
        doc.setPage(1);

        // Payment section layout
        const qrX = pageWidth - margin - 52;
        const qrY = paymentY;
        const qrWidth = 46;
        const qrHeight = 46;

        // Generate QR Code
        const qrString = generateQRString(formData, totalCost, generateDocumentNumber());
        const qr = qrcode(0, 'M');
        qr.addData(qrString);
        qr.make();
        
        // Convert QR code to data URL with higher resolution
        const scale = 4; // Increase scale factor for better resolution
        const cellSize = 1.5 * scale;
        const qrSize = qr.getModuleCount() * cellSize;
        const canvas = document.createElement('canvas');
        canvas.width = qrSize;
        canvas.height = qrSize;
        const ctx = canvas.getContext('2d');
        
        // Enable high-quality image rendering
        ctx.imageSmoothingEnabled = false;
        
        // Draw white background
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, qrSize, qrSize);
        
        // Draw QR code with higher resolution
        ctx.fillStyle = '#000000';
        for (let row = 0; row < qr.getModuleCount(); row++) {
            for (let col = 0; col < qr.getModuleCount(); col++) {
                if (qr.isDark(row, col)) {
                    ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                }
            }
        }

        // Add Swiss Cross in the center of QR code
        const moduleCount = qr.getModuleCount();
        const centerModule = Math.floor(moduleCount / 2);
        const crossModuleSize = 7; // Size of the cross area in modules
        const crossStart = centerModule - Math.floor(crossModuleSize / 2);
        
        // First draw a slightly larger white background
        const padding = cellSize * 0.5; // Add padding for white border
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(
            crossStart * cellSize - padding,
            crossStart * cellSize - padding,
            crossModuleSize * cellSize + padding * 2,
            crossModuleSize * cellSize + padding * 2
        );

        // Draw black background for cross
        ctx.fillStyle = '#000000';
        ctx.fillRect(
            crossStart * cellSize,
            crossStart * cellSize,
            crossModuleSize * cellSize,
            crossModuleSize * cellSize
        );

        // Draw the white Swiss cross
        const crossThickness = Math.ceil(cellSize * 1.5); // Thickness of cross lines
        const crossLength = Math.floor(crossModuleSize * cellSize * 0.6); // Length of cross lines
        const crossCenter = (crossStart + crossModuleSize / 2) * cellSize;

        ctx.fillStyle = '#ffffff';
        // Horizontal bar of the cross
        ctx.fillRect(
            crossCenter - crossLength / 2,
            crossCenter - crossThickness / 2,
            crossLength,
            crossThickness
        );
        // Vertical bar of the cross
        ctx.fillRect(
            crossCenter - crossThickness / 2,
            crossCenter - crossLength / 2,
            crossThickness,
            crossLength
        );

        // Draw white background rectangle for QR code
        doc.setFillColor(255, 255, 255);
        doc.rect(qrX - 2, qrY - 2, qrWidth + 4, qrHeight + 4, 'F');

        // Draw corner marks
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.5);
        
        // Top left corner
        doc.line(qrX - 2, qrY - 2, qrX + 3, qrY - 2);
        doc.line(qrX - 2, qrY - 2, qrX - 2, qrY + 3);
        
        // Top right corner
        doc.line(qrX + qrWidth - 3, qrY - 2, qrX + qrWidth + 2, qrY - 2);
        doc.line(qrX + qrWidth + 2, qrY - 2, qrX + qrWidth + 2, qrY + 3);
        
        // Bottom left corner
        doc.line(qrX - 2, qrY + qrHeight - 3, qrX - 2, qrY + qrHeight + 2);
        doc.line(qrX - 2, qrY + qrHeight + 2, qrX + 3, qrY + qrHeight + 2);
        
        // Bottom right corner
        doc.line(qrX + qrWidth - 3, qrY + qrHeight + 2, qrX + qrWidth + 2, qrY + qrHeight + 2);
        doc.line(qrX + qrWidth + 2, qrY + qrHeight - 3, qrX + qrWidth + 2, qrY + qrHeight + 2);

        // Add QR code
        doc.addImage(canvas.toDataURL('image/png', 1.0), 'PNG', qrX, qrY, qrWidth, qrHeight);

        // Add currency and amount section below QR code
        const currencyX = qrX;
        const currencyY = qrY + qrHeight + 8;
        doc.setFont("helvetica", "bold");
        doc.text("Währung", currencyX, currencyY);
        doc.text("Betrag", currencyX + 25, currencyY);
        
        doc.setFont("helvetica", "normal");
        doc.text("CHF", currencyX, currencyY + 5);
        doc.text(totalCost.toFixed(2), currencyX + 25, currencyY + 5);

        // Add separator line above payment information
        doc.setDrawColor(180, 180, 180); // Grauer Trennstrich
        doc.setLineWidth(0.3);
        doc.line(margin, qrY - 8, pageWidth - margin, qrY - 8); // 4px nach unten verschoben (von -12 zu -8)

        // Payment information layout
        const paymentInfoX = margin;
        const paymentStartY = qrY - 7;
        const lineSpacing = 6;

        // Zahlungsbedingungen
        doc.setFont("helvetica", "normal");
        doc.text(formData.payment_terms || costConfig.payment_terms, paymentInfoX, paymentStartY + 10);

        // Konto / Zahlbar an (mit Abstand)
        doc.setFont("helvetica", "bold");
        doc.text("Konto / Zahlbar an", paymentInfoX, paymentStartY + lineSpacing * 2 + 10);

        // IBAN
        doc.setFont("helvetica", "normal");
        doc.text(formData.company_iban || costConfig.company_iban, paymentInfoX, paymentStartY + lineSpacing * 3 + 10);

        // Name und Firma
        const bankInfoName = (formData.company_name || costConfig.company_name) ? 
            `${formData.sender_name || costConfig.sender_name}, ${formData.company_name || costConfig.company_name}` : 
            (formData.sender_name || costConfig.sender_name);
        doc.text(bankInfoName, paymentInfoX, paymentStartY + lineSpacing * 4 + 10);

        // Adresse
        doc.text(formData.company_street || costConfig.company_street, paymentInfoX, paymentStartY + lineSpacing * 5 + 10);
        doc.text(formData.company_city || costConfig.company_city, paymentInfoX, paymentStartY + lineSpacing * 6 + 10);

        // TWINT Information (mit zusätzlichem Abstand)
        if (formData.company_twint || costConfig.company_twint) {
            doc.text(`TWINT: ${formData.company_twint || costConfig.company_twint}`, paymentInfoX, paymentStartY + lineSpacing * 8 + 10);
        }

        // Footer
        doc.setFillColor(245, 245, 245);
        doc.rect(0, pageHeight - 6, pageWidth, 6, 'F');
        doc.setFontSize(8);
        doc.setTextColor(120, 120, 120);
        doc.text("Erstellt mit 3D Druck Kostenrechner", margin, pageHeight - 2);
        doc.text("© 2025 piodeer. All rights reserved.", pageWidth - margin, pageHeight - 2, { align: 'right' });

        // Save PDF
        const pdfName = `3D-Druck-Kostenrechnung_${currentDateStr.replace(/\./g, '-')}_${currentTimeStr.replace(':', '-')}.pdf`;
        doc.save(pdfName);
    };
}

// Modifiziere den Event Handler für den PDF Export Button
document.getElementById('pdfExportBtn').addEventListener('click', function() {
    const modal = document.getElementById('recipientModal');
    
    // Hole die aktuellen Werte aus den Einstellungs-Inputs
    const recipientFields = ['recipient_salutation', 'recipient_name', 'recipient_company', 'recipient_street', 
                           'recipient_city', 'recipient_email', 'recipient_phone', 'recipient_notes'];
    
    recipientFields.forEach(fieldId => {
        // Aktualisiere costConfig mit den aktuellen Werten aus den Einstellungen
        const settingsInput = document.querySelector(`.settings-group #${fieldId}`);
        if (settingsInput) {
            costConfig[fieldId] = settingsInput.value;
        }
        
        // Übertrage die Werte in das Modal
        const modalInput = document.querySelector(`#recipientModal #${fieldId}`);
        if (modalInput) {
            modalInput.value = costConfig[fieldId] || '';
        }
    });
    
    modal.style.display = "block";
});

// Modifiziere den Event Handler für den Bestätigen Button
document.getElementById('confirmPdfBtn').addEventListener('click', function() {
    const requiredFields = ['recipient_name', 'recipient_street', 'recipient_city'];
    const missingFields = requiredFields.filter(field => !document.getElementById(field).value.trim());
    
    if (missingFields.length > 0) {
        alert("Bitte füllen Sie alle Pflichtfelder aus.");
        return;
    }
    
    // Sammle alle Formularwerte
    const formData = { ...costConfig }; // Kopiere alle Einstellungen
    const inputs = document.querySelectorAll('#recipientModal input, #recipientModal textarea');
    inputs.forEach(input => {
        if (input.id && input.value.trim()) {
            formData[input.id] = input.value.trim();
        }
    });
    
    // Speichere die aktuellen Empfänger-Daten für die nächste Verwendung
    const recipientData = {};
    Object.keys(formData).forEach(key => {
        if (key.startsWith('recipient_')) {
            recipientData[key] = formData[key];
            // Aktualisiere auch die Standardeinstellungen
            costConfig[key] = formData[key];
        }
    });
    localStorage.setItem('lastRecipientData', JSON.stringify(recipientData));
    localStorage.setItem('costSettings', JSON.stringify(costConfig));
    
    // Schließe das Modal
    document.getElementById('recipientModal').style.display = "none";
    
    // Generiere das PDF mit allen Daten
    exportToPDF(formData);
});

// Event Handler für Abbrechen Button
document.getElementById('cancelPdfBtn').addEventListener('click', function() {
    document.getElementById('recipientModal').style.display = "none";
});

// Schließen des Modals
document.querySelector('#recipientModal .close').addEventListener('click', function() {
    document.getElementById('recipientModal').style.display = "none";
});

// Füge zusätzliche CSS-Styles hinzu
const style = document.createElement('style');
style.textContent = `
    .modal-content {
        padding: 25px;
    }
    
    .settings-grid {
        margin-top: 20px;
    }
    
    .settings-group {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
    }
    
    .settings-group h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #64b5f6;
        border-bottom: 2px solid #64b5f6;
        padding-bottom: 5px;
    }
    
    .setting-item {
        margin-bottom: 15px;
    }
    
    .setting-item label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }
    
    .setting-item input,
    .setting-item textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .setting-item input:focus,
    .setting-item textarea:focus {
        border-color: #64b5f6;
        outline: none;
        box-shadow: 0 0 5px rgba(100, 181, 246, 0.2);
    }
    
    .modal input:required {
        border-left: 3px solid #64b5f6;
    }
    
    @media (max-width: 768px) {
        .settings-grid {
            grid-template-columns: 1fr !important;
        }
    }
`;
document.head.appendChild(style);

// Funktion zum Formatieren des Datums
function formatDate(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}.${month}.${year}`;
}

// Funktion zum Formatieren der Zeit
function formatTime(date) {
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
}

// Funktion zur Generierung der Dokumentennummer
function generateDocumentNumber() {
    // Hole die letzte Nummer aus dem localStorage oder starte bei 0
    let lastNumber = parseInt(localStorage.getItem('lastDocumentNumber') || '0');
    
    // Erhöhe die Nummer um 1
    lastNumber++;
    
    // Speichere die neue Nummer
    localStorage.setItem('lastDocumentNumber', lastNumber.toString());
    
    // Formatiere die Nummer mit führenden Nullen auf 8 Stellen
    const formattedNumber = lastNumber.toString().padStart(8, '0');
    
    return `KR-${formattedNumber}`;
}

// Modifiziere das Empfänger-Modal HTML
const recipientModal = document.getElementById('recipientModal');
if (recipientModal) {
    const modalContent = recipientModal.querySelector('.modal-content');
    if (modalContent) {
        const settingsGrid = modalContent.querySelector('.settings-grid');
        if (settingsGrid) {
            settingsGrid.innerHTML = `
                <div class="settings-group">
                    <div class="setting-item">
                        <label>Anrede</label>
                        <input type="text" id="recipient_salutation">
                    </div>
                    <div class="setting-item">
                        <label>Name/Nachname*</label>
                        <input type="text" id="recipient_name" required>
                    </div>
                    <div class="setting-item">
                        <label>Firmenname</label>
                        <input type="text" id="recipient_company">
                    </div>
                    <div class="setting-item">
                        <label>Straße*</label>
                        <input type="text" id="recipient_street" required>
                    </div>
                    <div class="setting-item">
                        <label>PLZ/Ort*</label>
                        <input type="text" id="recipient_city" required>
                    </div>
                    <div class="setting-item">
                        <label>E-Mail</label>
                        <input type="email" id="recipient_email">
                    </div>
                    <div class="setting-item">
                        <label>Telefon</label>
                        <input type="tel" id="recipient_phone">
                    </div>
                    <div class="setting-item">
                        <label>Bemerkungen</label>
                        <textarea id="recipient_notes" rows="3" style="width: 100%; padding: 8px;"></textarea>
                    </div>
                </div>
            `;
        }
    }
}
</script>
<footer>
<p style="font-size: 12px; color: #888;">
© 2025 piodeer. All rights reserved. Created with
<a href="https://github.com/hoedii/3D-Druck-Kostenrechner" style="color: inherit; text-decoration: none;" target="_blank">Github</a>, Cursor & ChatGPT.
</p>
</footer>
</body>
</html>
