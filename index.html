<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D-Druck Kostenrechner</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f8f9fa; }
    h1 { color: #333; }
    input, button { padding: 0.5rem; margin: 0.5rem 0; }
    #result { margin-top: 1rem; background: #fff; padding: 1rem; border-radius: 5px; box-shadow: 0 0 5px #ccc; }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>ðŸ§¾ 3D-Druck Kostenrechner</h1>
  <input type="file" id="gcodeInput" accept=".gcode" />
  <button onclick="parseGCode()">Kosten berechnen</button>

  <div id="result" style="display: none">
    <h2>Ergebnis</h2>
    <pre id="output"></pre>
  </div>

  <script>
    const config = {
      time_price_per_hour: 2.75,
      time_price_per_hour5: 2.0,
      time_price_per_hour10: 1.5,
      energy_price_per_kwh: 0.40,
      material_price_per_kg: {
        PLA: 24.0,
        ABS: 23.0,
        TPU: 28.0,
        PETG: 18.0,
        ASA: 32.0,
        default: 20.0
      },
      printer_power_watt: 250
    };

    function parseTime(str) {
      const match = str.match(/(?:(\d+)d)?\s*(?:(\d+)h)?\s*(?:(\d+)m)?\s*(?:(\d+)s)?/);
      if (!match) return 0;
      const [_, d, h, m, s] = match.map(x => parseInt(x) || 0);
      return d * 24 + h + m / 60 + s / 3600;
    }

    function parseGCode() {
      const fileInput = document.getElementById('gcodeInput');
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function () {
        const lines = reader.result.split('\n');
        let filament = 0;
        let timeStr = '';
        let material = 'Unknown';

        for (const line of lines) {
          if (line.includes('; total filament used [g]')) {
            const match = line.match(/=\s*(\d+\.\d+)/);
            if (match) filament = parseFloat(match[1]);
          }
          if (line.includes('; print_time')) {
            const match = line.match(/=\s*([\ddhms\s]+)/);
            if (match) timeStr = match[1].trim();
          }
          if (line.includes('; paint_info')) {
            try {
              const match = line.match(/=\s*(\[.*\])/);
              if (match) {
                const info = JSON.parse(match[1]);
                if (Array.isArray(info) && info.length > 0) {
                  material = info[0].material_type || 'Unknown';
                }
              }
            } catch (e) {
              console.warn('Fehler beim Parsen von paint_info:', e);
            }
          }
        }

        const timeHours = parseTime(timeStr);
        const materialPrice = config.material_price_per_kg[material] || config.material_price_per_kg.default;
        const materialCost = (filament / 1000) * materialPrice;

        let timeRate = config.time_price_per_hour;
        if (timeHours > 5 && timeHours <= 10) timeRate = config.time_price_per_hour5;
        else if (timeHours > 10) timeRate = config.time_price_per_hour10;

        const timeCost = timeHours * timeRate;
        const energyKWh = (config.printer_power_watt * timeHours) / 1000;
        const energyCost = energyKWh * config.energy_price_per_kwh;
        const total = materialCost + timeCost + energyCost;

        const output = `Materialtyp: ${material}
Verbrauchtes Filament: ${filament.toFixed(2)} g
Druckzeit: ${timeHours.toFixed(2)} h (${timeStr})

Materialkosten: ${materialCost.toFixed(2)} CHF
Zeitkosten: ${timeCost.toFixed(2)} CHF
Stromkosten: ${energyCost.toFixed(2)} CHF

Gesamtkosten: ${total.toFixed(2)} CHF`;

        document.getElementById('output').textContent = output;
        document.getElementById('result').style.display = 'block';
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>